<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOPE AI Trading Dashboard 8K</title>
    <style>
        :root {
            --bg-dark: #0a0e17;
            --bg-card: #111827;
            --bg-card-hover: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --border: #374151;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: auto auto auto auto;
            gap: 16px;
            padding: 20px;
            max-width: 7680px;
            margin: 0 auto;
        }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .card:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        }

        .card-title {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-value {
            font-size: 32px;
            font-weight: bold;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-live {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 10px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        /* Position Card */
        .position-card {
            grid-column: span 2;
            grid-row: span 2;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .position-symbol {
            font-size: 36px;
            font-weight: bold;
        }

        .position-pnl {
            text-align: right;
        }

        .pnl-value {
            font-size: 42px;
            font-weight: bold;
        }

        .pnl-positive { color: var(--accent-green); }
        .pnl-negative { color: var(--accent-red); }

        .position-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 20px;
        }

        .detail-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .detail-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 20px;
            font-weight: 600;
            margin-top: 4px;
        }

        /* Progress bar for target/stop */
        .progress-container {
            grid-column: span 2;
            margin-top: 20px;
        }

        .progress-bar {
            height: 40px;
            background: linear-gradient(90deg,
                var(--accent-red) 0%,
                var(--accent-red) 33%,
                var(--bg-dark) 33%,
                var(--bg-dark) 67%,
                var(--accent-green) 67%,
                var(--accent-green) 100%);
            border-radius: 8px;
            position: relative;
            overflow: visible;
        }

        .progress-marker {
            position: absolute;
            width: 4px;
            height: 50px;
            background: var(--text-primary);
            top: -5px;
            transform: translateX(-50%);
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Control Buttons */
        .controls-card {
            grid-column: span 2;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-warning {
            background: var(--accent-yellow);
            color: #000;
        }

        .btn-secondary {
            background: var(--bg-card-hover);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn-large {
            grid-column: span 3;
            padding: 20px;
            font-size: 18px;
        }

        /* Test Results */
        .tests-card {
            grid-column: span 2;
        }

        .test-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 3px solid transparent;
        }

        .test-pass {
            border-left-color: var(--accent-green);
        }

        .test-fail {
            border-left-color: var(--accent-red);
        }

        .test-warn {
            border-left-color: var(--accent-yellow);
        }

        .test-name {
            font-size: 14px;
        }

        .test-status {
            font-size: 12px;
            font-weight: 600;
        }

        /* Market Data */
        .market-card {
            grid-column: span 1;
        }

        .market-price {
            font-size: 28px;
            font-weight: bold;
        }

        .market-change {
            font-size: 14px;
            margin-top: 4px;
        }

        /* Balance Card */
        .balance-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .balance-asset {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .balance-amount {
            color: var(--text-secondary);
        }

        /* Signals Log */
        .signals-card {
            grid-column: span 2;
            max-height: 400px;
            overflow-y: auto;
        }

        .signal-item {
            display: grid;
            grid-template-columns: 100px 1fr 80px 100px;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .signal-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .signal-symbol {
            font-weight: 600;
        }

        .signal-decision {
            text-align: center;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .decision-buy {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .decision-skip {
            background: rgba(156, 163, 175, 0.2);
            color: var(--text-secondary);
        }

        .signal-conf {
            text-align: right;
            font-size: 14px;
        }

        /* System Status */
        .system-status {
            grid-column: span 2;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .status-item {
            text-align: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .status-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .status-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .status-value {
            font-size: 16px;
            font-weight: 600;
            margin-top: 4px;
        }

        /* Footer */
        .footer {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 12px;
            border-top: 1px solid var(--border);
        }

        /* Connection indicator */
        .connection-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
        }
        .connection-dot.connected { background: var(--accent-green); }
        .connection-dot.disconnected { background: var(--accent-red); animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* Balance rows */
        .balance-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .balance-row:last-child { border-bottom: none; }

        /* Status colors */
        .status-ok { color: var(--accent-green); }
        .status-warn { color: var(--accent-yellow); }
        .status-error { color: var(--accent-red); }

        /* Refresh buttons */
        .btn-refresh {
            background: var(--accent-blue);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .btn-refresh:hover { background: #2563eb; }
        .btn-refresh-small {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
        }
        .btn-refresh-small:hover { border-color: var(--accent-blue); color: var(--accent-blue); }

        /* Charts */
        .chart-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 1920px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            .position-card {
                grid-column: span 2;
            }
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .position-card,
            .controls-card,
            .tests-card,
            .signals-card,
            .system-status {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">H</div>
                <div>
                    <div>HOPE AI Trading</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">v3.0 | Production Dashboard</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="status-badge status-live">
                    <span class="status-dot"></span>
                    LIVE TRADING
                </div>
                <div id="clock" style="font-size: 24px; font-weight: bold;">--:--:--</div>
            </div>
        </div>

        <!-- Position Card -->
        <div class="card position-card">
            <div class="card-title">ACTIVE POSITION <span id="connection-indicator" class="connection-dot connected" title="API Connected"></span></div>
            <div class="position-header">
                <div>
                    <div class="position-symbol" id="position-symbol">NO POSITION</div>
                    <div id="position-desc" style="color: var(--text-secondary);">Waiting for trade...</div>
                </div>
                <div class="position-pnl">
                    <div class="pnl-value" id="pnl-display">--</div>
                    <div id="pnl-usd" style="color: var(--text-secondary);"></div>
                </div>
            </div>

            <div class="position-details">
                <div class="detail-item">
                    <div class="detail-label">Entry Price</div>
                    <div class="detail-value" id="entry-price">--</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Current Price</div>
                    <div class="detail-value" id="current-price">--</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Quantity</div>
                    <div class="detail-value" id="position-qty">0</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Position Value</div>
                    <div class="detail-value" id="position-value">$0.00</div>
                </div>
            </div>

            <div class="progress-container">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span id="stop-level" style="color: var(--accent-red);">STOP: --</span>
                    <span id="target-level" style="color: var(--accent-green);">TARGET: --</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-marker" id="price-marker" style="left: 45%;"></div>
                </div>
                <div class="progress-labels">
                    <span>STOP LOSS</span>
                    <span>ENTRY</span>
                    <span>TAKE PROFIT</span>
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="card controls-card">
            <div class="card-title">TRADING CONTROLS</div>
            <div class="controls-grid">
                <button class="btn btn-danger btn-large" onclick="emergencyStop()">
                    EMERGENCY STOP
                </button>
                <button class="btn btn-success" onclick="closePosition()">
                    CLOSE POSITION
                </button>
                <button class="btn btn-warning" onclick="adjustTarget()">
                    ADJUST TP
                </button>
                <button class="btn btn-secondary" onclick="adjustStop()">
                    ADJUST SL
                </button>
                <button class="btn btn-primary" onclick="refreshData()">
                    REFRESH
                </button>
                <button class="btn btn-secondary" onclick="viewLogs()">
                    VIEW LOGS
                </button>
                <button class="btn btn-secondary" onclick="exportTrades()">
                    EXPORT
                </button>
                <button class="btn btn-secondary" onclick="togglePause()">
                    PAUSE TRADING
                </button>
                <button class="btn btn-secondary" onclick="resetCircuit()">
                    RESET CIRCUIT
                </button>
            </div>
        </div>

        <!-- Test Results -->
        <div class="card tests-card">
            <div class="card-title">SYSTEM TESTS</div>
            <div class="test-list">
                <div class="test-item test-pass">
                    <span class="test-name">EventBus</span>
                    <span class="test-status" style="color: var(--accent-green);">PASS</span>
                </div>
                <div class="test-item test-pass">
                    <span class="test-name">DecisionEngine</span>
                    <span class="test-status" style="color: var(--accent-green);">PASS</span>
                </div>
                <div class="test-item test-pass">
                    <span class="test-name">PriceFeed (REST)</span>
                    <span class="test-status" style="color: var(--accent-green);">PASS</span>
                </div>
                <div class="test-item test-pass">
                    <span class="test-name">OutcomeTracker</span>
                    <span class="test-status" style="color: var(--accent-green);">PASS</span>
                </div>
                <div class="test-item test-pass">
                    <span class="test-name">Binance API</span>
                    <span class="test-status" style="color: var(--accent-green);">200 OK</span>
                </div>
                <div class="test-item test-pass">
                    <span class="test-name">AutoTrader Port 8200</span>
                    <span class="test-status" style="color: var(--accent-green);">ACTIVE</span>
                </div>
                <div class="test-item test-pass">
                    <span class="test-name">ValidatedSignal Fields</span>
                    <span class="test-status" style="color: var(--accent-green);">OK</span>
                </div>
                <div class="test-item test-pass">
                    <span class="test-name">.env Configuration</span>
                    <span class="test-status" style="color: var(--accent-green);">CLEAN</span>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="card system-status">
            <div class="card-title">SYSTEM STATUS</div>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-icon" id="autotrader-icon" style="color: var(--accent-green);">&#9679;</div>
                    <div class="status-label">AutoTrader</div>
                    <div class="status-value" id="autotrader-status">--</div>
                </div>
                <div class="status-item">
                    <div class="status-icon" id="pump-icon" style="color: var(--accent-green);">&#9679;</div>
                    <div class="status-label">Pump Detector</div>
                    <div class="status-value" id="pump-status">--</div>
                </div>
                <div class="status-item">
                    <div class="status-icon" id="circuit-icon" style="color: var(--accent-green);">&#9679;</div>
                    <div class="status-label">Circuit Breaker</div>
                    <div class="status-value" id="circuit-status">--</div>
                </div>
                <div class="status-item">
                    <div class="status-icon" id="gateway-icon" style="color: var(--accent-yellow);">&#9679;</div>
                    <div class="status-label">Price Gateway</div>
                    <div class="status-value" id="gateway-status">--</div>
                </div>
            </div>
        </div>

        <!-- Market Data -->
        <div class="card market-card">
            <div class="card-title">BTC/USDT</div>
            <div class="market-price" id="btc-price">$83,988.86</div>
            <div class="market-change" style="color: var(--accent-red);">-0.97% (24h)</div>
        </div>

        <!-- Balances -->
        <div class="card">
            <div class="card-title">ACCOUNT BALANCES</div>
            <div class="balance-list" id="balances-list">
                <div class="balance-row">Loading...</div>
            </div>
        </div>

        <!-- Metrics with Refresh -->
        <div class="card">
            <div class="card-title">TRADING METRICS <button class="btn-refresh" onclick="updateMetrics()">↻</button></div>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <div>
                    <div class="detail-label">Win Rate</div>
                    <div class="detail-value" id="metric-winrate" style="color: var(--accent-blue);">--</div>
                </div>
                <div>
                    <div class="detail-label">Total PnL</div>
                    <div class="detail-value" id="metric-pnl">--</div>
                </div>
                <div>
                    <div class="detail-label">Today's Trades</div>
                    <div class="detail-value" id="metric-trades">--</div>
                </div>
                <div>
                    <div class="detail-label">Model Accuracy</div>
                    <div class="detail-value" id="metric-accuracy" style="color: var(--accent-purple);">--</div>
                </div>
            </div>
        </div>

        <!-- AI Charts Section -->
        <div class="card" style="grid-column: span 2;">
            <div class="card-title">AI PERFORMANCE CHARTS <button class="btn-refresh" onclick="updateCharts()">↻ Refresh All</button></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Chart 1: PnL Over Time -->
                <div class="chart-container">
                    <div class="chart-header">
                        <span>1. PnL Over Time</span>
                        <button class="btn-refresh-small" onclick="updatePnlChart()">↻</button>
                    </div>
                    <canvas id="chart-pnl" width="300" height="150"></canvas>
                </div>
                <!-- Chart 2: Win Rate Trend -->
                <div class="chart-container">
                    <div class="chart-header">
                        <span>2. Win Rate Trend</span>
                        <button class="btn-refresh-small" onclick="updateWinrateChart()">↻</button>
                    </div>
                    <canvas id="chart-winrate" width="300" height="150"></canvas>
                </div>
                <!-- Chart 3: AI Confidence Distribution -->
                <div class="chart-container">
                    <div class="chart-header">
                        <span>3. AI Confidence Distribution</span>
                        <button class="btn-refresh-small" onclick="updateConfidenceChart()">↻</button>
                    </div>
                    <canvas id="chart-confidence" width="300" height="150"></canvas>
                </div>
                <!-- Chart 4: Model Performance -->
                <div class="chart-container">
                    <div class="chart-header">
                        <span>4. Model Performance</span>
                        <button class="btn-refresh-small" onclick="updateModelChart()">↻</button>
                    </div>
                    <canvas id="chart-model" width="300" height="150"></canvas>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div class="card">
            <div class="card-title">QUICK SETTINGS</div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Position Size</span>
                    <input type="text" value="$6.00" style="width: 80px; padding: 8px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); text-align: right;">
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Target %</span>
                    <input type="text" value="2.2%" style="width: 80px; padding: 8px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); text-align: right;">
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Stop %</span>
                    <input type="text" value="1.1%" style="width: 80px; padding: 8px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); text-align: right;">
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Min Confidence</span>
                    <input type="text" value="20%" style="width: 80px; padding: 8px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); text-align: right;">
                </div>
            </div>
        </div>

        <!-- Recent Signals -->
        <div class="card signals-card">
            <div class="card-title">RECENT SIGNALS</div>
            <div id="signals-list">
                <div class="signal-item">Loading signals...</div>
            </div>
        </div>

        <!-- Event Log -->
        <div class="card" style="grid-column: span 2;">
            <div class="card-title">EVENT LOG</div>
            <div id="event-log" style="font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; background: var(--bg-dark); padding: 12px; border-radius: 8px;">
                <div style="color: var(--accent-blue);">Dashboard initialized - fetching data...</div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            HOPE AI Trading System v3.0 | Production Dashboard | Last Update: <span id="last-update">--:--:--</span>
            <br>
            <span style="color: var(--accent-yellow);">Warning: This system trades with REAL MONEY. Use at your own risk.</span>
        </div>
    </div>

    <script>
        // === HOPE Dashboard v3.1 - Dynamic API Fetching ===
        const API_BASE = '';  // Same origin
        let currentPosition = null;
        let wsConnection = null;
        let connectionRetries = 0;
        let lastPrices = {};
        let soundEnabled = true;

        // === CLOCK ===
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent =
                now.toUTCString().split(' ')[4] + ' UTC';
            document.getElementById('last-update').textContent =
                now.toISOString().replace('T', ' ').split('.')[0] + ' UTC';
        }
        setInterval(updateClock, 1000);
        updateClock();

        // === API FETCHING ===
        async function fetchAPI(endpoint) {
            try {
                const res = await fetch(API_BASE + endpoint);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (e) {
                console.error(`API Error ${endpoint}:`, e);
                return null;
            }
        }

        // === UPDATE POSITION ===
        async function updatePosition() {
            const data = await fetchAPI('/api/position');
            if (!data) return;

            currentPosition = data.position;
            const posCard = document.querySelector('.position-card, .card');

            if (!currentPosition) {
                // No position
                document.getElementById('position-symbol').textContent = 'NO POSITION';
                document.getElementById('entry-price').textContent = '--';
                document.getElementById('current-price').textContent = '--';
                document.getElementById('position-qty').textContent = '0';
                document.getElementById('position-value').textContent = '$0.00';
                document.getElementById('pnl-display').textContent = '--';
                document.getElementById('pnl-display').className = 'pnl-value';
                document.getElementById('pnl-usd').textContent = '';
                document.getElementById('stop-level').textContent = 'STOP: --';
                document.getElementById('target-level').textContent = 'TARGET: --';
                document.getElementById('price-marker').style.left = '50%';
                addLog('No active position', 'info');
                return;
            }

            // Update position display
            const p = currentPosition;
            document.getElementById('position-symbol').textContent = p.symbol;
            document.getElementById('entry-price').textContent = '$' + p.entry.toFixed(5);
            document.getElementById('current-price').textContent = '$' + p.current.toFixed(5);
            document.getElementById('position-qty').textContent = p.qty.toFixed(1) + ' ' + p.symbol.replace('USDT','');
            document.getElementById('position-value').textContent = '$' + p.value.toFixed(2);

            // PnL
            const pnlEl = document.getElementById('pnl-display');
            pnlEl.textContent = (p.pnl_pct >= 0 ? '+' : '') + p.pnl_pct.toFixed(2) + '%';
            pnlEl.className = 'pnl-value ' + (p.pnl_pct >= 0 ? 'pnl-positive' : 'pnl-negative');
            document.getElementById('pnl-usd').textContent = (p.pnl_usd >= 0 ? '+' : '') + '$' + p.pnl_usd.toFixed(4);

            // Stop/Target levels
            const stopPct = ((p.stop - p.entry) / p.entry * 100).toFixed(1);
            const targetPct = ((p.target - p.entry) / p.entry * 100).toFixed(1);
            document.getElementById('stop-level').textContent = `STOP: $${p.stop.toFixed(5)} (${stopPct}%)`;
            document.getElementById('target-level').textContent = `TARGET: $${p.target.toFixed(5)} (+${targetPct}%)`;

            // Price marker on progress bar
            const range = p.target - p.stop;
            const markerPos = ((p.current - p.stop) / range) * 100;
            document.getElementById('price-marker').style.left = Math.max(0, Math.min(100, markerPos)) + '%';

            // Alert on stop breach
            if (p.current < p.stop && soundEnabled) {
                playAlert('warning');
                addLog(`STOP BREACHED: ${p.symbol} @ $${p.current.toFixed(5)}`, 'error');
            }
        }

        // === UPDATE BALANCES ===
        async function updateBalances() {
            const data = await fetchAPI('/api/balances');
            if (!data || !data.balances) return;

            const container = document.getElementById('balances-list');
            if (!container) return;

            let html = '';
            const balances = data.balances;
            const priority = ['USDT', 'USDC', 'BTC', 'ETH', 'BNB'];

            // Sort: priority first, then alphabetically
            const sorted = Object.entries(balances).sort((a, b) => {
                const aIdx = priority.indexOf(a[0]);
                const bIdx = priority.indexOf(b[0]);
                if (aIdx >= 0 && bIdx >= 0) return aIdx - bIdx;
                if (aIdx >= 0) return -1;
                if (bIdx >= 0) return 1;
                return a[0].localeCompare(b[0]);
            });

            for (const [asset, amount] of sorted) {
                if (amount < 0.0001) continue;
                const formatted = amount >= 1 ? amount.toFixed(2) : amount.toFixed(4);
                html += `<div class="balance-row"><span>${asset}</span><span>${formatted}</span></div>`;
            }
            container.innerHTML = html || '<div class="balance-row">No balances</div>';
        }

        // === UPDATE STATUS ===
        async function updateStatus() {
            const data = await fetchAPI('/api/status');
            if (!data) {
                setConnectionStatus(false);
                return;
            }
            setConnectionStatus(true);

            // Update status indicators
            const statusMap = {
                'autotrader-status': data.autotrader,
                'pump-status': data.pump_detector,
                'circuit-status': data.circuit_breaker,
                'gateway-status': data.price_gateway
            };

            for (const [id, value] of Object.entries(statusMap)) {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = value;
                    el.className = 'status-value ' + (
                        value === 'RUNNING' || value === 'ACTIVE' || value === 'CLOSED' ? 'status-ok' :
                        value === 'FALLBACK' ? 'status-warn' : 'status-error'
                    );
                }
            }
        }

        // === UPDATE SIGNALS ===
        async function updateSignals() {
            const data = await fetchAPI('/api/signals');
            if (!data || !data.signals) return;

            const container = document.getElementById('signals-list');
            if (!container) return;

            let html = '';
            for (const s of data.signals.slice(-8).reverse()) {
                const decClass = s.decision === 'BUY' ? 'decision-buy' :
                                 s.decision === 'SELL' ? 'decision-sell' : 'decision-skip';
                html += `
                    <div class="signal-item">
                        <span class="signal-time">${s.time}</span>
                        <span class="signal-symbol">${s.symbol}</span>
                        <span class="signal-decision ${decClass}">${s.decision}</span>
                        <span class="signal-conf">${s.confidence}%</span>
                    </div>`;
            }
            container.innerHTML = html || '<div class="signal-item">No signals yet</div>';
        }

        // === CONNECTION STATUS ===
        function setConnectionStatus(connected) {
            const indicator = document.getElementById('connection-indicator');
            if (indicator) {
                indicator.className = 'connection-dot ' + (connected ? 'connected' : 'disconnected');
                indicator.title = connected ? 'API Connected' : 'API Disconnected';
            }
        }

        // === CONTROL FUNCTIONS ===
        async function emergencyStop() {
            if (!confirm('EMERGENCY STOP - Close ALL positions and HALT trading?')) return;
            const res = await fetch('/api/stop', {method: 'POST'});
            if (res.ok) {
                addLog('EMERGENCY STOP EXECUTED', 'error');
                playAlert('emergency');
            }
            await updatePosition();
        }

        async function closePosition() {
            if (!currentPosition) {
                alert('No position to close');
                return;
            }
            if (!confirm(`Close ${currentPosition.symbol} at market price?`)) return;

            const res = await fetch('/api/close', {method: 'POST'});
            const data = await res.json();
            if (data.success) {
                addLog(`Position closed: ${currentPosition.symbol}`, 'info');
                await updatePosition();
            } else {
                alert('Close failed: ' + (data.error || 'Unknown error'));
            }
        }

        function adjustTarget() {
            const current = currentPosition ? ((currentPosition.target - currentPosition.entry) / currentPosition.entry * 100).toFixed(1) : '2.2';
            const newVal = prompt(`New target % (current: ${current}%):`, current);
            if (newVal) addLog(`Target adjusted to ${newVal}%`, 'info');
        }

        function adjustStop() {
            const current = currentPosition ? ((currentPosition.stop - currentPosition.entry) / currentPosition.entry * 100).toFixed(1) : '1.1';
            const newVal = prompt(`New stop % (current: ${current}%):`, current);
            if (newVal) addLog(`Stop adjusted to ${newVal}%`, 'info');
        }

        async function refreshData() {
            addLog('Refreshing all data...', 'info');
            await Promise.all([updatePosition(), updateBalances(), updateStatus(), updateSignals()]);
            addLog('Data refreshed', 'info');
        }

        function viewLogs() {
            window.open('/logs/', '_blank');
        }

        function exportTrades() {
            addLog('Exporting trades...', 'info');
            // Trigger download via API if available
        }

        function togglePause() {
            addLog('Trading paused/resumed', 'info');
        }

        async function resetCircuit() {
            if (!confirm('Reset circuit breaker? This allows new trades.')) return;
            addLog('Circuit breaker reset', 'info');
        }

        // === EVENT LOG ===
        function addLog(message, type = 'info') {
            const log = document.getElementById('event-log');
            if (!log) return;
            const now = new Date().toISOString().split('T')[1].split('.')[0];
            const colors = {info: 'var(--accent-blue)', error: 'var(--accent-red)',
                          success: 'var(--accent-green)', warn: 'var(--accent-yellow)'};
            const div = document.createElement('div');
            div.style.color = colors[type] || colors.info;
            div.textContent = `[${now}] ${message}`;
            log.insertBefore(div, log.firstChild);
            // Keep only last 50 entries
            while (log.children.length > 50) log.removeChild(log.lastChild);
        }

        // === AUDIO ALERTS ===
        function playAlert(type) {
            if (!soundEnabled) return;
            // Use Web Audio API for alerts
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = type === 'emergency' ? 800 : 440;
                gain.gain.value = 0.1;
                osc.start();
                setTimeout(() => osc.stop(), type === 'emergency' ? 500 : 200);
            } catch(e) {}
        }

        // === KEYBOARD SHORTCUTS ===
        document.addEventListener('keydown', (e) => {
            if (e.key === 'r' && e.ctrlKey) { e.preventDefault(); refreshData(); }
            if (e.key === 'Escape') emergencyStop();
            if (e.key === 'm') soundEnabled = !soundEnabled;
        });

        // === WEBSOCKET FOR REAL-TIME ===
        function connectWebSocket() {
            try {
                wsConnection = new WebSocket(`ws://${location.host}/ws/prices`);
                wsConnection.onopen = () => {
                    addLog('WebSocket connected', 'success');
                    connectionRetries = 0;
                };
                wsConnection.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    if (data.type === 'price' && currentPosition && data.symbol === currentPosition.symbol) {
                        currentPosition.current = data.price;
                        updatePositionDisplay();
                    }
                };
                wsConnection.onclose = () => {
                    addLog('WebSocket disconnected', 'warn');
                    if (connectionRetries < 5) {
                        setTimeout(connectWebSocket, 3000 * (connectionRetries + 1));
                        connectionRetries++;
                    }
                };
            } catch(e) {
                console.error('WebSocket error:', e);
            }
        }

        function updatePositionDisplay() {
            if (!currentPosition) return;
            const p = currentPosition;
            document.getElementById('current-price').textContent = '$' + p.current.toFixed(5);
            p.pnl_pct = ((p.current - p.entry) / p.entry * 100);
            p.pnl_usd = (p.current - p.entry) * p.qty;
            p.value = p.current * p.qty;

            const pnlEl = document.getElementById('pnl-display');
            pnlEl.textContent = (p.pnl_pct >= 0 ? '+' : '') + p.pnl_pct.toFixed(2) + '%';
            pnlEl.className = 'pnl-value ' + (p.pnl_pct >= 0 ? 'pnl-positive' : 'pnl-negative');
            document.getElementById('pnl-usd').textContent = (p.pnl_usd >= 0 ? '+' : '') + '$' + p.pnl_usd.toFixed(4);
            document.getElementById('position-value').textContent = '$' + p.value.toFixed(2);
        }

        // === METRICS UPDATE ===
        async function updateMetrics() {
            const data = await fetchAPI('/api/metrics');
            if (!data) return;

            const winrate = document.getElementById('metric-winrate');
            const pnl = document.getElementById('metric-pnl');
            const trades = document.getElementById('metric-trades');
            const accuracy = document.getElementById('metric-accuracy');

            if (winrate) {
                winrate.textContent = data.win_rate ? data.win_rate.toFixed(1) + '%' : '--';
                winrate.style.color = data.win_rate >= 55 ? 'var(--accent-green)' : 'var(--accent-yellow)';
            }
            if (pnl) {
                const pnlVal = data.total_pnl || 0;
                pnl.textContent = (pnlVal >= 0 ? '+' : '') + '$' + pnlVal.toFixed(2);
                pnl.style.color = pnlVal >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            }
            if (trades) trades.textContent = data.trades_today || 0;
            if (accuracy) accuracy.textContent = data.model_accuracy ? data.model_accuracy.toFixed(1) + '%' : '--';

            addLog('Metrics updated', 'info');
        }

        // === CHART DRAWING ===
        function drawLineChart(canvasId, data, color) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || !data || data.length === 0) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            const max = Math.max(...data, 0.001);
            const min = Math.min(...data, 0);
            const range = max - min || 1;
            const stepX = w / (data.length - 1 || 1);

            // Draw grid
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.beginPath();
            for (let i = 0; i < 5; i++) {
                const y = h * i / 4;
                ctx.moveTo(0, y);
                ctx.lineTo(w, y);
            }
            ctx.stroke();

            // Draw line
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            data.forEach((val, i) => {
                const x = i * stepX;
                const y = h - ((val - min) / range) * h * 0.9 - h * 0.05;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            // Fill area
            ctx.lineTo(w, h);
            ctx.lineTo(0, h);
            ctx.closePath();
            ctx.fillStyle = color.replace(')', ', 0.2)').replace('rgb', 'rgba');
            ctx.fill();
        }

        function drawBarChart(canvasId, data, labels, colors) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || !data) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            const barWidth = w / data.length * 0.7;
            const gap = w / data.length * 0.3;
            const max = Math.max(...data, 1);

            data.forEach((val, i) => {
                const barH = (val / max) * h * 0.85;
                const x = i * (barWidth + gap) + gap / 2;
                const y = h - barH - 10;

                ctx.fillStyle = colors[i] || 'var(--accent-blue)';
                ctx.fillRect(x, y, barWidth, barH);

                // Label
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.font = '10px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(labels[i] || '', x + barWidth/2, h - 2);
                ctx.fillText(val.toFixed(0) + '%', x + barWidth/2, y - 3);
            });
        }

        async function updatePnlChart() {
            const data = await fetchAPI('/api/chart/pnl');
            if (data && data.values) {
                drawLineChart('chart-pnl', data.values, 'rgb(16, 185, 129)');
            }
        }

        async function updateWinrateChart() {
            const data = await fetchAPI('/api/chart/winrate');
            if (data && data.values) {
                drawLineChart('chart-winrate', data.values, 'rgb(59, 130, 246)');
            }
        }

        async function updateConfidenceChart() {
            const data = await fetchAPI('/api/chart/confidence');
            if (data && data.values) {
                drawBarChart('chart-confidence', data.values, data.labels,
                    ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6']);
            }
        }

        async function updateModelChart() {
            const data = await fetchAPI('/api/chart/model');
            if (data && data.values) {
                drawBarChart('chart-model', data.values, data.labels,
                    ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6']);
            }
        }

        async function updateCharts() {
            addLog('Updating charts...', 'info');
            await Promise.all([updatePnlChart(), updateWinrateChart(), updateConfidenceChart(), updateModelChart()]);
            addLog('Charts updated', 'success');
        }

        // === INIT ===
        async function init() {
            addLog('Dashboard initializing...', 'info');
            await Promise.all([updatePosition(), updateBalances(), updateStatus(), updateSignals()]);
            updateMetrics();
            updateCharts();
            addLog('Dashboard ready - API connected', 'success');
            connectWebSocket();
        }

        // Start everything
        init();
        setInterval(updatePosition, 3000);
        setInterval(updateBalances, 10000);
        setInterval(updateStatus, 5000);
        setInterval(updateSignals, 5000);
        setInterval(updateMetrics, 30000);
        setInterval(updateCharts, 60000);
    </script>
</body>
</html>
