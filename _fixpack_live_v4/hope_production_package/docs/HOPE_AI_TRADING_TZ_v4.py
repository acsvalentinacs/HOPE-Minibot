# ══════════════════════════════════════════════════════════════════════════════
# HOPE AI TRADING SYSTEM v4.0 — ТЕХНИЧЕСКОЕ ЗАДАНИЕ
# ══════════════════════════════════════════════════════════════════════════════
# Версия: 4.0 (Production Upgrade)
# Дата: 2026-01-30
# Авторы: Claude (Opus 4.5) + GPT-5.2 Thinking
# SSoT: docs/HOPE_AI_TRADING_TZ_v4.md
# ══════════════════════════════════════════════════════════════════════════════

"""
EXECUTIVE SUMMARY
═════════════════════════════════════════════════════════════════════════════════

ПРОДУКТ:     Автономная торговая система с self-improving AI
ВЕРСИЯ:      v4.0 (Production Upgrade)  
ЦЕЛЬ:        ПОЛНЫЙ ТОРГОВЫЙ ЦИКЛ без заглушек
РЕЖИМ:       TESTNET (24ч) → LIVE (после валидации)
ПРИНЦИПЫ:    fail-closed, atomic operations, sha256 contracts, cannot bypass

═════════════════════════════════════════════════════════════════════════════════
КРИТИЧЕСКОЕ ПРАВИЛО: ИНТЕГРАЦИЯ ОБЯЗАТЕЛЬНА
═════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│  ПРОБЛЕМА (была):                                                           │
│  Файлы создавались, но НЕ ИНТЕГРИРОВАЛИСЬ в реальную систему               │
│  → Колесо есть, но машина не едет!                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│  РЕШЕНИЕ (P0):                                                              │
│  1. Каждый файл = часть ЦЕЛОГО пакета                                       │
│  2. install.ps1 = автоматическая интеграция                                │
│  3. verify.ps1 = проверка что ВСЁ работает                                 │
│  4. НЕ ЗАВЕРШАТЬ ЗАДАЧУ пока verify.ps1 не покажет PASS                    │
│                                                                             │
│  ФОРМУЛА:                                                                   │
│  ЗАДАЧА_ВЫПОЛНЕНА = файлы_созданы AND интегрированы AND verify_PASS        │
└─────────────────────────────────────────────────────────────────────────────┘

═════════════════════════════════════════════════════════════════════════════════
"""

# ══════════════════════════════════════════════════════════════════════════════
# РАЗДЕЛ 1: CONTEXT
# ══════════════════════════════════════════════════════════════════════════════

CONTEXT = """
Проект:      HOPE AI Trading System v4.0
SSoT:        docs/HOPE_AI_TRADING_TZ_v4.md
Sources:     state/sources/sources.json (auto-managed)
Working Dir: C:\\Users\\kirillDev\\Desktop\\TradingBot\\minibot
"""

# ══════════════════════════════════════════════════════════════════════════════
# РАЗДЕЛ 2: PRINCIPLES (MANDATORY)
# ══════════════════════════════════════════════════════════════════════════════

PRINCIPLES = """
1. Fail-closed:        сомнение = FAIL (не торгуем)
2. Atomic writes:      temp → fsync → replace
3. Contracts:          sha256: prefix для верификации
4. No "next step":     execute NOW
5. Cannot bypass:      Signal Gate обязателен для ВСЕХ
6. Integration first:  файл без интеграции = НЕ СДЕЛАНО
7. Verify always:      verify.ps1 должен показать PASS
"""

# ══════════════════════════════════════════════════════════════════════════════
# РАЗДЕЛ 3: ПОЛНЫЙ ТОРГОВЫЙ ЦИКЛ (БЕЗ ЗАГЛУШЕК)
# ══════════════════════════════════════════════════════════════════════════════

FULL_TRADING_CYCLE = """
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ПОЛНЫЙ ТОРГОВЫЙ ЦИКЛ v4.0                                 │
│              Signal → AI → Binance → Exit → PnL → Learning                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐                                                           │
│  │   MoonBot    │                                                           │
│  │   Signal     │                                                           │
│  └──────┬───────┘                                                           │
│         │                                                                   │
│         ▼                                                                   │
│  ╔══════════════════════════════════════════════════════════════════════╗   │
│  ║  STAGE 1: SIGNAL GATE (ЕДИНЫЙ ФИЛЬТР) — cannot bypass                ║   │
│  ║  Файл: core/signal_gate.py                                           ║   │
│  ╠══════════════════════════════════════════════════════════════════════╣   │
│  ║  ✓ AllowList check (CORE + DYNAMIC + HOT)                            ║   │
│  ║  ✓ Blacklist check (BTC, ETH, stablecoins)                           ║   │
│  ║  ✓ Delta >= 10% для Telegram                                         ║   │
│  ║  ✓ Delta >= 2% для торговли                                          ║   │
│  ║  ✓ Type filter (block MICRO, TEST_ACTIVITY, SCALP)                   ║   │
│  ║  ✓ BTC dump protection (-1% за 5 мин → SKIP альты)                   ║   │
│  ║  ✓ Pump exhaustion (+20% за час → SKIP)                              ║   │
│  ║  ✓ Dedupe (300 сек окно)                                             ║   │
│  ║  ✓ Cooldown (120 сек на символ)                                      ║   │
│  ║  ✓ Rate limit (10/мин глобально)                                     ║   │
│  ╚══════════════════════════════════════════════════════════════════════╝   │
│         │                                                                   │
│         │ PASS                                                              │
│         ▼                                                                   │
│  ╔══════════════════════════════════════════════════════════════════════╗   │
│  ║  STAGE 2: EYE OF GOD v4 (AI DECISION)                                ║   │
│  ║  Файл: core/eye_of_god_v4.py                                         ║   │
│  ╠══════════════════════════════════════════════════════════════════════╣   │
│  ║  ✓ Multi-factor scoring (delta, volume, buys/sec, orderbook)         ║   │
│  ║  ✓ Technical analysis (RSI, MACD, Bollinger)                         ║   │
│  ║  ✓ BTC correlation check                                             ║   │
│  ║  ✓ Historical pattern matching                                       ║   │
│  ║  ✓ Confidence calculation                                            ║   │
│  ║  ✓ Mode routing (SCALP / SWING / SKIP)                               ║   │
│  ╚══════════════════════════════════════════════════════════════════════╝   │
│         │                                                                   │
│         │ BUY (confidence >= 0.65)                                          │
│         ▼                                                                   │
│  ╔══════════════════════════════════════════════════════════════════════╗   │
│  ║  STAGE 3: ADAPTIVE TP/SL ENGINE                                      ║   │
│  ║  Файл: core/adaptive_tp_engine.py                                    ║   │
│  ╠══════════════════════════════════════════════════════════════════════╣   │
│  ║  ✓ TP = f(delta, ATR, historical_reversal)                           ║   │
│  ║  ✓ SL = TP / 3.0 (R:R >= 3:1 ОБЯЗАТЕЛЬНО)                            ║   │
│  ║  ✓ Friction учёт (0.2% round-trip)                                   ║   │
│  ║  ✓ Position size = f(confidence)                                     ║   │
│  ║  ✓ Timeout = f(volatility)                                           ║   │
│  ╚══════════════════════════════════════════════════════════════════════╝   │
│         │                                                                   │
│         │ TP=3%, SL=1%, Size=70%                                            │
│         ▼                                                                   │
│  ╔══════════════════════════════════════════════════════════════════════╗   │
│  ║  STAGE 4: BINANCE OCO EXECUTOR                                       ║   │
│  ║  Файл: execution/binance_oco_executor.py                             ║   │
│  ╠══════════════════════════════════════════════════════════════════════╣   │
│  ║  ✓ MARKET entry (мгновенный вход)                                    ║   │
│  ║  ✓ OCO order сразу (TP + SL)                                         ║   │
│  ║  ✓ Trailing stop после +0.5%                                         ║   │
│  ║  ✓ Breakeven после +1%                                               ║   │
│  ║  ✓ Kill switch (Emergency Stop)                                      ║   │
│  ║  ✓ Order status monitoring                                           ║   │
│  ║  ✓ Timeout handling                                                  ║   │
│  ╚══════════════════════════════════════════════════════════════════════╝   │
│         │                                                                   │
│         │ ORDER_FILLED / TP_HIT / SL_HIT / TIMEOUT                          │
│         ▼                                                                   │
│  ╔══════════════════════════════════════════════════════════════════════╗   │
│  ║  STAGE 5: TRADE OUTCOME LOGGER                                       ║   │
│  ║  Файл: learning/trade_outcome_logger.py                              ║   │
│  ╠══════════════════════════════════════════════════════════════════════╣   │
│  ║  ✓ Запись в state/trades/trades.jsonl                                ║   │
│  ║  ✓ PnL calculation (с учётом комиссии)                               ║   │
│  ║  ✓ MFE/MAE tracking                                                  ║   │
│  ║  ✓ Exit reason (TP/SL/TIMEOUT/TRAILING)                              ║   │
│  ║  ✓ Signal metadata для ML                                            ║   │
│  ╚══════════════════════════════════════════════════════════════════════╝   │
│         │                                                                   │
│         │ trade_outcome.jsonl                                               │
│         ▼                                                                   │
│  ╔══════════════════════════════════════════════════════════════════════╗   │
│  ║  STAGE 6: SELF-LEARNING LOOP                                         ║   │
│  ║  Файл: learning/self_improver.py                                     ║   │
│  ╠══════════════════════════════════════════════════════════════════════╣   │
│  ║  ✓ WinRate per symbol update                                         ║   │
│  ║  ✓ Optimal TP per symbol                                             ║   │
│  ║  ✓ Historical reversal patterns                                      ║   │
│  ║  ✓ Adaptive thresholds                                               ║   │
│  ║  ✓ Blacklist auto-update (WR < 30% → blacklist)                      ║   │
│  ╚══════════════════════════════════════════════════════════════════════╝   │
│         │                                                                   │
│         │ Updated Eye of God weights                                        │
│         ▼                                                                   │
│  ╔══════════════════════════════════════════════════════════════════════╗   │
│  ║  STAGE 7: TELEGRAM SIGNALS INBOX                                     ║   │
│  ║  Файл: telegram/signals_inbox.py                                     ║   │
│  ╠══════════════════════════════════════════════════════════════════════╣   │
│  ║  ✓ Один закреплённый message (не спам!)                              ║   │
│  ║  ✓ Last 10 HOT signals                                               ║   │
│  ║  ✓ Inline кнопки: [HOT ONLY] [ALL LOGGED] [CLEAR]                    ║   │
│  ║  ✓ Обновление каждые 5 минут                                         ║   │
│  ╚══════════════════════════════════════════════════════════════════════╝   │
│         │                                                                   │
│         │                                                                   │
│         ▼                                                                   │
│  ╔══════════════════════════════════════════════════════════════════════╗   │
│  ║  STAGE 8: DASHBOARD v3 (8K)                                          ║   │
│  ║  Файл: dashboard/dashboard_v3_8k.html                                ║   │
│  ╠══════════════════════════════════════════════════════════════════════╣   │
│  ║  ВЕРХ (каждую минуту):                                               ║   │
│  ║    [🛑 STOP ALL] [LIVE MODE?] [LOSS: $56/$500] [Restart]             ║   │
│  ║  ЦЕНТР (каждые 10 минут):                                            ║   │
│  ║    HOT signals | Текущие позиции | TP/SL                             ║   │
│  ║  НИЗ (раз в день):                                                   ║   │
│  ║    Статистика | Обучение | Backtest                                  ║   │
│  ╚══════════════════════════════════════════════════════════════════════╝   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
"""

# ══════════════════════════════════════════════════════════════════════════════
# РАЗДЕЛ 4: ФАЙЛЫ ДЛЯ СОЗДАНИЯ (ОБЯЗАТЕЛЬНО)
# ══════════════════════════════════════════════════════════════════════════════

FILES_TO_CREATE = """
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ФАЙЛЫ ДЛЯ СОЗДАНИЯ (P0)                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  CORE (cannot bypass):                                                      │
│  ──────────────────────────────────────────────────────────────────────────│
│  1. core/signal_gate.py              Единый фильтр (GPT: SignalFilter)     │
│  2. core/adaptive_tp_engine.py       Адаптивный TP/SL (R:R >= 3:1)         │
│  3. core/eye_of_god_v4.py            AI с self-learning                    │
│                                                                             │
│  EXECUTION:                                                                 │
│  ──────────────────────────────────────────────────────────────────────────│
│  4. execution/binance_oco_executor.py   OCO ордера (TP+SL)                 │
│  5. execution/trailing_stop.py          Trailing после +0.5%               │
│                                                                             │
│  LEARNING:                                                                  │
│  ──────────────────────────────────────────────────────────────────────────│
│  6. learning/trade_outcome_logger.py    Запись результатов                 │
│  7. learning/self_improver.py           Обучение на outcomes               │
│                                                                             │
│  TELEGRAM:                                                                  │
│  ──────────────────────────────────────────────────────────────────────────│
│  8. telegram/signals_inbox.py           Закреплённый message               │
│                                                                             │
│  CONFIG:                                                                    │
│  ──────────────────────────────────────────────────────────────────────────│
│  9. config/signal_filter_rules.json     Правила фильтрации (GPT)           │
│  10. config/live_trade_policy.py        Blacklist тяжёлых монет            │
│                                                                             │
│  TOOLS:                                                                     │
│  ──────────────────────────────────────────────────────────────────────────│
│  11. tools/install.ps1                  Автоматическая интеграция          │
│  12. tools/verify.ps1                   Проверка что ВСЁ работает          │
│  13. tools/runtime_smoke.py             Smoke test                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
"""

# ══════════════════════════════════════════════════════════════════════════════
# РАЗДЕЛ 5: БЛОКИРУЮЩИЙ ВОПРОС (GPT)
# ══════════════════════════════════════════════════════════════════════════════

BLOCKING_QUESTION = """
╔═════════════════════════════════════════════════════════════════════════════╗
║                    БЛОКИРУЮЩИЙ ВОПРОС (fail-closed)                         ║
╠═════════════════════════════════════════════════════════════════════════════╣
║                                                                             ║
║  TESTNET или LIVE сейчас?                                                   ║
║                                                                             ║
║  ✅ TESTNET-финализация (полный цикл ордеров, safe)                         ║
║  ⚠️ LIVE small-cap scalping (капитал ≤50 USDT)                              ║
║                                                                             ║
║  Без ответа — fail-closed, LIVE не делаю.                                   ║
║                                                                             ║
╚═════════════════════════════════════════════════════════════════════════════╝
"""

# ══════════════════════════════════════════════════════════════════════════════
# РАЗДЕЛ 6: R:R RATIO С УЧЁТОМ FRICTION (GPT)
# ══════════════════════════════════════════════════════════════════════════════

RR_RATIO_WITH_FRICTION = """
┌─────────────────────────────────────────────────────────────────────────────┐
│                    R:R RATIO С УЧЁТОМ FRICTION                               │
│                    (улучшение от GPT)                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ФОРМУЛА:                                                                   │
│  ──────────────────────────────────────────────────────────────────────────│
│  net_win = target - friction                                                │
│  net_loss = sl + friction                                                   │
│  breakeven_winrate = net_loss / (net_win + net_loss)                        │
│                                                                             │
│  friction = 0.20% (round-trip: 0.1% вход + 0.1% выход)                      │
│                                                                             │
│  ПРИМЕР SUPER_SCALP:                                                        │
│  ──────────────────────────────────────────────────────────────────────────│
│  БЫЛО:  target=0.5%, sl=0.3%                                                │
│         net_win = 0.5 - 0.2 = 0.3%                                          │
│         net_loss = 0.3 + 0.2 = 0.5%                                         │
│         eff_RR = 0.3/0.5 = 0.6 → breakeven WR = 62.5% ❌                    │
│                                                                             │
│  СТАЛО: target=1.5%, sl=0.5%                                                │
│         net_win = 1.5 - 0.2 = 1.3%                                          │
│         net_loss = 0.5 + 0.2 = 0.7%                                         │
│         eff_RR = 1.3/0.7 = 1.86 → breakeven WR = 35% ✅                     │
│                                                                             │
│  ВЫВОД: Микро-таргеты при заметной фрикции = статистически токсичны!       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
"""

# ══════════════════════════════════════════════════════════════════════════════
# РАЗДЕЛ 7: ADAPTIVE TP FORMULA (GPT + Claude)
# ══════════════════════════════════════════════════════════════════════════════

ADAPTIVE_TP_FORMULA = """
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ADAPTIVE TP FORMULA                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  TP = min(                                                                  │
│      delta * 0.4,                    # 40% от силы пампа                    │
│      historical_reversal * 0.6,      # 60% от среднего отката              │
│      ATR_1h * 2.0,                   # 2x ATR                               │
│  )                                                                          │
│                                                                             │
│  SL = TP / 3.0                       # R:R = 3:1 минимум                    │
│                                                                             │
│  FLOOR: TP >= 1.0% (после friction)                                        │
│  CEILING: TP <= 10.0%                                                       │
│                                                                             │
│  ПРИМЕР:                                                                    │
│  ──────────────────────────────────────────────────────────────────────────│
│  Signal: ENSO +20%, ATR=2%, hist_reversal=8%                               │
│                                                                             │
│  TP = min(20*0.4, 8*0.6, 2*2.0) = min(8%, 4.8%, 4%) = 4%                   │
│  SL = 4% / 3 = 1.33%                                                       │
│                                                                             │
│  Результат: TP=4%, SL=1.33%, R:R=3:1 ✅                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
"""

# ══════════════════════════════════════════════════════════════════════════════
# РАЗДЕЛ 8: PROCESS MANAGEMENT (GPT улучшение)
# ══════════════════════════════════════════════════════════════════════════════

PROCESS_MANAGEMENT = """
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PROCESS MANAGEMENT (GPT улучшение)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  БЫЛО (грубо):                                                              │
│  Get-Process python | Stop-Process -Force  ← убивает ВСЁ!                  │
│                                                                             │
│  СТАЛО (таргетированно):                                                    │
│  ──────────────────────────────────────────────────────────────────────────│
│                                                                             │
│  # 1. DRY-RUN: посмотреть что будет остановлено                            │
│  Get-CimInstance Win32_Process -Filter "Name='python.exe'" | `             │
│    Where-Object { $_.CommandLine -match "pump_detector|run_live" } | `     │
│    ForEach-Object { "WOULD-STOP PID=$($_.ProcessId)" }                     │
│                                                                             │
│  # 2. APPLY: остановить только нужные                                      │
│  Get-CimInstance Win32_Process -Filter "Name='python.exe'" | `             │
│    Where-Object { $_.CommandLine -match "pump_detector|run_live" } | `     │
│    ForEach-Object { Stop-Process -Id $_.ProcessId -Force }                 │
│                                                                             │
│  # 3. P1: Single-instance lock + watchdog                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
"""

# ══════════════════════════════════════════════════════════════════════════════
# РАЗДЕЛ 9: INTEGRATION PROTOCOL (РЕШЕНИЕ ГЛАВНОЙ ПРОБЛЕМЫ)
# ══════════════════════════════════════════════════════════════════════════════

INTEGRATION_PROTOCOL = """
╔═════════════════════════════════════════════════════════════════════════════╗
║           INTEGRATION PROTOCOL — РЕШЕНИЕ ГЛАВНОЙ ПРОБЛЕМЫ                   ║
╠═════════════════════════════════════════════════════════════════════════════╣
║                                                                             ║
║  ПРОБЛЕМА: Файлы создавались, но НЕ ИНТЕГРИРОВАЛИСЬ                        ║
║                                                                             ║
║  РЕШЕНИЕ: КАЖДЫЙ ПАКЕТ ДОЛЖЕН СОДЕРЖАТЬ:                                   ║
║  ══════════════════════════════════════════════════════════════════════════║
║                                                                             ║
║  1. manifest.json                                                           ║
║     - Список файлов + SHA256                                               ║
║     - target_path для каждого файла                                        ║
║                                                                             ║
║  2. install.ps1                                                             ║
║     - Автоматическое копирование файлов                                    ║
║     - Backup старых версий                                                 ║
║     - Патч существующих файлов (pump_detector.py)                          ║
║     - SHA256 верификация                                                   ║
║                                                                             ║
║  3. verify.ps1                                                              ║
║     - py_compile всех .py файлов                                           ║
║     - runtime_smoke.py                                                     ║
║     - Проверка что процессы запускаются                                    ║
║     - Проверка что спам прекратился                                        ║
║                                                                             ║
║  4. rollback.ps1                                                            ║
║     - Восстановление из backup                                             ║
║                                                                             ║
║  ФОРМУЛА ЗАВЕРШЕНИЯ ЗАДАЧИ:                                                 ║
║  ══════════════════════════════════════════════════════════════════════════║
║                                                                             ║
║  TASK_DONE = files_created                                                  ║
║            AND install.ps1_executed                                         ║
║            AND verify.ps1_PASS                                              ║
║            AND user_confirmed_working                                       ║
║                                                                             ║
║  Если verify.ps1 показывает FAIL → задача НЕ ЗАВЕРШЕНА!                    ║
║                                                                             ║
╚═════════════════════════════════════════════════════════════════════════════╝
"""

# ══════════════════════════════════════════════════════════════════════════════
# РАЗДЕЛ 10: TASK COMPLETION FORMAT
# ══════════════════════════════════════════════════════════════════════════════

TASK_COMPLETION_FORMAT = """
=== TASK COMPLETION ===

Task: [описание задачи]
Result: PASS / FAIL / BLOCKED

Checkpoint: [git commit hash] [date]
Rollback: git reset --hard [previous_hash]

Artifacts:
  - created: [список созданных файлов]
  - modified: [список изменённых файлов]
  - sha256: [хэши]

Verification:
  - install.ps1: PASS/FAIL
  - verify.ps1: PASS/FAIL
  - runtime_smoke.py: PASS/FAIL
  - user_confirmed: YES/NO

If BLOCKED:
  - Blocked-By: [что блокирует]
  - Required: [что нужно для продолжения]
"""

# ══════════════════════════════════════════════════════════════════════════════
# РАЗДЕЛ 11: EXPECTATIONS
# ══════════════════════════════════════════════════════════════════════════════

EXPECTATIONS = """
1. Аудит входных данных (найти скрытые ошибки)
2. Решение под ключ (не "могу сделать", а СДЕЛАНО)
3. Артефакты: файлы, команды проверки, py_compile
4. install.ps1 + verify.ps1 обязательно
5. TASK_DONE только если verify.ps1 = PASS
6. Формат TASK COMPLETION в конце
"""

# ══════════════════════════════════════════════════════════════════════════════
# PRINT ALL
# ══════════════════════════════════════════════════════════════════════════════

if __name__ == "__main__":
    print("=" * 80)
    print("HOPE AI TRADING SYSTEM v4.0 — ТЕХНИЧЕСКОЕ ЗАДАНИЕ")
    print("=" * 80)
    print()
    print(CONTEXT)
    print(PRINCIPLES)
    print(FULL_TRADING_CYCLE)
    print(FILES_TO_CREATE)
    print(BLOCKING_QUESTION)
    print(RR_RATIO_WITH_FRICTION)
    print(ADAPTIVE_TP_FORMULA)
    print(PROCESS_MANAGEMENT)
    print(INTEGRATION_PROTOCOL)
    print(TASK_COMPLETION_FORMAT)
    print(EXPECTATIONS)
